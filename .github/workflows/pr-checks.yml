name: 'PR Formatting'
on:
  workflow_dispatch:
  pull_request_target:
    types:
      - opened
      - reopened
      - edited
      - synchronize

defaults:
  run:
    shell: bash

permissions:
  contents: read
  checks: write
  statuses: write

concurrency:
  group: pr-checks-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  title-check:
    name: Title Check
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.base.repo.fork }}
    permissions:
      checks: write
      statuses: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Check PR Title
        uses: step-security/conventional-pr-title-action@cb1c5657ccf4c42f5c0a6c0708cb8251b960d902 # v3.2.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  changelog-check:
    name: Changelog Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Validate CHANGELOG.md has changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" != "pull_request_target" && "${{ github.event_name }}" != "pull_request" ]]; then
            echo "Not a pull request event. Skipping."
            exit 0
          fi

          PR_NUMBER="${{ github.event.pull_request.number }}"
          if [[ -z "${PR_NUMBER}" ]]; then
            echo "Unable to determine PR number."
            exit 1
          fi

          echo "Checking files changed in PR #${PR_NUMBER}..."

          # List files in the PR and check for CHANGELOG.md (root or any path ending with /CHANGELOG.md)
          FILES_JSON="$(gh api repos/${{ github.repository }}/pulls/${PR_NUMBER}/files --paginate)"
          if ! echo "${FILES_JSON}" | jq -e '.[] | select(.filename | test("(^|/)CHANGELOG\\.md$"; "i"))' >/dev/null; then
            echo "‚ùå FAIL: CHANGELOG.md was not changed in this PR."
            echo ""
            echo "Please add an entry to CHANGELOG.md under the [Unreleased] section."
            exit 1
          fi

          # Ensure there is at least one line-level change (+ or -) in the patch for CHANGELOG.md
          PATCH_CONTENT="$(echo "${FILES_JSON}" \
            | jq -r '.[] | select(.filename | test("(^|/)CHANGELOG\\.md$"; "i")) | .patch // empty')"

          # If no patch is returned (very large file or API omission), treat presence as sufficient
          if [[ -z "${PATCH_CONTENT}" ]]; then
            echo "‚úÖ PASS: CHANGELOG.md modified (no patch provided by API)."
            exit 0
          fi

          # Extract only the added lines from the patch (lines starting with +, excluding +++ header)
          ADDED_LINES="$(echo "${PATCH_CONTENT}" | grep -E '^\+' | grep -v '^\+\+\+' || true)"

          # Check if there are any actual additions
          if [[ -z "${ADDED_LINES}" ]]; then
            echo "‚ùå FAIL: No line-level additions detected in CHANGELOG.md."
            echo ""
            echo "Please add an entry to CHANGELOG.md under the [Unreleased] section."
            exit 1
          fi

          # Check if changes are under [Unreleased]
          # Parse the patch to track which section we're in and validate additions
          IN_UNRELEASED=false
          IN_RELEASED_VERSION=false
          FOUND_VALID_ADDITION=false
          RELEASED_VERSION_FOUND=""

          while IFS= read -r line; do
            # Check for [Unreleased] header (context line or added line)
            if [[ "$line" =~ \[Unreleased\] ]]; then
              IN_UNRELEASED=true
              IN_RELEASED_VERSION=false
              RELEASED_VERSION_FOUND=""
            fi

            # Check for released version header pattern: ## [X.Y.Z] - DATE
            # Match both context and added lines
            if [[ "$line" =~ \[([0-9]+\.[0-9]+\.[0-9]+)\].*-.*[0-9]{4} ]]; then
              # We found a released version header
              RELEASED_VERSION_FOUND="${BASH_REMATCH[1]}"
              IN_UNRELEASED=false
              IN_RELEASED_VERSION=true
            fi

            # Check for added lines (starting with +, not +++)
            if [[ "$line" =~ ^\+[^+] ]]; then
              # Extract the actual content (remove the leading +)
              ADDED_CONTENT="${line:1}"

              # Skip empty lines and section headers
              if [[ -n "$ADDED_CONTENT" && ! "$ADDED_CONTENT" =~ ^###\ ]]; then
                if [[ "$IN_UNRELEASED" == true ]]; then
                  FOUND_VALID_ADDITION=true
                elif [[ "$IN_RELEASED_VERSION" == true && -n "$RELEASED_VERSION_FOUND" ]]; then
                  # Found an addition under a released version - this is wrong
                  echo "‚ùå FAIL: Changelog entry found under a released version, not under [Unreleased]."
                  echo ""
                  echo "You added content under version [$RELEASED_VERSION_FOUND] instead of [Unreleased]:"
                  echo "  $ADDED_CONTENT"
                  echo ""
                  echo "üìù Please move your changes to the [Unreleased] section at the top of CHANGELOG.md"
                  echo ""
                  echo "Example structure:"
                  echo "  ## [Unreleased]"
                  echo "  ### Added"
                  echo "  - Your new feature or fix here"
                  exit 1
                fi
              fi
            fi
          done <<< "$PATCH_CONTENT"

          if [[ "$FOUND_VALID_ADDITION" == true ]]; then
            echo "‚úÖ PASS: CHANGELOG.md contains valid additions under [Unreleased]."
            exit 0
          else
            echo "‚ùå FAIL: No valid changelog entries found under [Unreleased]."
            echo ""
            echo "Please ensure your changes are added under the [Unreleased] section of CHANGELOG.md"
            echo ""
            echo "Example:"
            echo "  ## [Unreleased]"
            echo "  ### Added"
            echo "  - Your feature/fix description"
            exit 1
          fi
