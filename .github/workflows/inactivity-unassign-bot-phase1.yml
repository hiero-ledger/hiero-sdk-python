name: PythonBot - Inactivity Unassign Bot (Phase 1)

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  inactivity-unassign:
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2
        with:
          egress-policy: audit

      - name: Unassign inactive assignees with NO PRs (Phase 1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          DAYS: 21
        run: |
          set -euo pipefail

          echo "Running Phase 1 inactivity check on $REPO (threshold: $DAYS days)..."
          NOW_TS=$(date +%s)

          # Get all open issues (and PRs) with at least one assignee.
          # PRs are filtered out below after we inspect each item.
          ISSUES=$(gh api "repos/$REPO/issues" \
            --paginate \
            --jq '.[] | select(.state=="open" and (.assignees | length > 0)) | .number')

          if [ -z "$ISSUES" ]; then
            echo "No open issues with assignees found."
            exit 0
          fi

          for ISSUE in $ISSUES; do
            echo "Issue #$ISSUE"

            ISSUE_JSON=$(gh api "repos/$REPO/issues/$ISSUE")

            # Skip pull requests â€“ this bot should only unassign from issues.
            IS_PR=$(echo "$ISSUE_JSON" | jq 'has("pull_request")')
            if [ "$IS_PR" = "true" ]; then
              echo "  â†’ This item is a pull request, not an issue. Skipping."
              echo
              continue
            fi

            CREATED_AT=$(echo "$ISSUE_JSON" | jq -r '.created_at')
            CREATED_TS=$(date -d "$CREATED_AT" +%s)
            DIFF_DAYS=$(( (NOW_TS - CREATED_TS) / 86400 ))

            ASSIGNEES=$(echo "$ISSUE_JSON" | jq -r '.assignees[].login')

            for USER in $ASSIGNEES; do
              echo "  - Assignee: $USER"

              # Does this user have ANY PRs in this repo?
              USER_PRS=$(gh pr list --repo "$REPO" --search "author:$USER" \
                --json number --jq '.[].number')

              if [ -n "$USER_PRS" ]; then
                echo "      â†’ has PR(s) in repo â†’ skip in Phase 1."
                continue
              fi

              if [ "$DIFF_DAYS" -ge "$DAYS" ]; then
                echo "      â†’ NO PR & assigned for $DIFF_DAYS days â†’ UNASSIGNING $USER"

                # Unassign the user
                gh api "repos/$REPO/issues/$ISSUE/assignees" \
                  -X DELETE \
                  -f assignees[]="$USER"

                # Leave a friendly comment on the issue
                gh issue comment "$ISSUE" --repo "$REPO" --body "Hi @$USER, you were automatically unassigned from this issue because there has been no linked pull request for **$DAYS days**. This helps keep issues available for contributors who are currently active. You're very welcome to get re-assigned to this issue or pick up another one whenever you have availability ðŸš€"
              else
                echo "      â†’ NO PR but only $DIFF_DAYS days â†’ not stale yet."
              fi

            done

            echo
          done

          echo "Phase 1 inactivity unassign check complete."
