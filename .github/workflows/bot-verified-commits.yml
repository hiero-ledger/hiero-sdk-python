# .github/workflows/bot-verified-commits.yml
#
# Verifies that all commits in a pull request are GPG-signed.
# Posts a one-time VerificationBot comment if unverified commits are found.
#
# This workflow uses pull_request_target for security with fork PRs.
# Logic is handled by .github/scripts/bot-verified-commits.js
#
# Configuration is done via environment variables for easy customization.

name: PythonBot - Verify PR Commits

on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: "verify-commits-${{ github.event.pull_request.number }}"
  cancel-in-progress: true

jobs:
  verify-commits:
    runs-on: ubuntu-latest

    # =========================================================================
    # CONFIGURATION - All customizable values are defined here as env vars
    # =========================================================================
    env:
      # Bot identity
      BOT_NAME: "VerificationBot"
      BOT_LOGIN: "github-actions"

      # Comment marker for duplicate detection
      COMMENT_MARKER: "[commit-verification-bot]"

      # Documentation links
      SIGNING_GUIDE_URL: "https://github.com/hiero-ledger/hiero-sdk-python/blob/main/docs/sdk_developers/signing.md"
      README_URL: "https://github.com/hiero-ledger/hiero-sdk-python/blob/main/README.md"
      DISCORD_URL: "https://github.com/hiero-ledger/hiero-sdk-python/blob/main/docs/discord.md"

      # Team signature
      TEAM_NAME: "Hiero Python SDK Team"

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: .github/scripts
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"

      - name: Verify PR commits
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        id: verify
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: json
          script: |
            const script = require('./.github/scripts/bot-verified-commits.js');
            const result = await script({ github, context });

            // Set outputs for downstream steps if needed
            core.setOutput('success', result.success);
            core.setOutput('unverified_count', result.unverifiedCount);

            return result;

      - name: Fail if unverified commits found
        if: steps.verify.outputs.success != 'true'
        run: |
          echo "‚ùå Pull request has unverified commits."
          echo "Please sign your commits with GPG and DCO."
          echo "See: ${{ env.SIGNING_GUIDE_URL }}"
          exit 1
