name: 'PR Formatting'
on:
  workflow_dispatch:
  pull_request_target:
    types:
      - opened
      - reopened
      - edited
      - synchronize

defaults:
  run:
    shell: bash

permissions:
  contents: read
  checks: write
  statuses: write
  pull-requests: write  # Added for bot to comment

concurrency:
  group: pr-checks-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  title-check:
    name: Title Check
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.base.repo.fork }}
    permissions:
      checks: write
      statuses: write
      pull-requests: write  # Added for bot to comment
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Check PR Title
        id: check-title
        uses: step-security/conventional-pr-title-action@cb1c5657ccf4c42f5c0a6c0708cb8251b960d902 # v3.2.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Checkout repository to access bot script
      - name: Checkout repository
        if: failure()
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # Run bot to comment on PR with helpful guidance
      - name: Comment on PR with title guidance
        if: failure()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const script = require('./.github/scripts/bot-conventional-pr-title.js');
            
            // Run the bot with required parameters
            await script.run({
              github: github,
              context: context,
              prNumber: context.issue.number,
              prTitle: context.payload.pull_request.title
            });
